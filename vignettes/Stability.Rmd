# Microbiome stability analysis

Download example data - HITChip Atlas of 130 genus-like taxa across 1006 healthy western adults from [Lahti et al. Nat. Comm. 5:4344, 2014](http://www.nature.com/ncomms/2014/140708/ncomms5344/full/ncomms5344.html). A subset of 76 subjects have also short time series for temporal stability analysis:

```{r bistability}
library(microbiome)
pseq <- download_microbiome("atlas1006")
```


## Intermediate stability 

Quantify temporal stability across the abundance range for each taxa

```{r bistability2}
stability <- intermediate_stability(pseq, method = "correlation")
intermediate.stability <- sapply(stability, function (x) {x$stability})
```


## Bimodality analysis

Multiple scores are available to calculate coefficients of bimodality
for each taxonomic group. Some of the scores are more generally
quantifying multimodality, or deviation from unimodality but do not
yield estimates of the number of modes. 

```{r bimodality, message=FALSE, warning=FALSE, fig.path = "figure/"}
# Pick samples from zero time point (cross-sectional analysis)
pseq0 <- subset_samples(pseq, time == 0 & DNA_extraction_method == "r")

# Bimodality score with potential analysis + bootstrap 
bimodality <- multimodality(pseq0, method = "potential_bootstrap")

# Coefficient of bimodality. Also see the function coefficient_of_bimodality
bimodality.coef <- multimodality(pseq0, method = "coefficient_of_bimodality")
```

DIP test for multimodality:

```{r bimodality-dip, message=FALSE, warning=FALSE, fig.path = "figure/"}
# DIP multimodality test uses the separate diptest package.
library(diptest)

# Pick OTU log10 data
otu <- otu_table(pseq0)@.Data
dip <- apply(otu, 1, function (x) dip.test(x, simulate.p.value = TRUE, B = 1000))
dip2 <- data.frame(t(sapply(dip, function (x) {c(x$statistic, x$p.value)})))
colnames(dip2) <- c("score", "p.value")
dip2$tax <- names(dip)

# Dip measures unimodality. Values range between 0 to 1. 
# Values less than 0.05 indicate significant deviation from unimodality. 
# To score multimodality, use the inverse:
multimodality.dip <- 1 - dip2$score
```


Compare the alternative bimodality scores

```{r bimodality-comp, message=FALSE, warning=FALSE, fig.path = "figure/"}
pairs(cbind(pb = bimodality, bc = bimodality.coef, dip = multimodality.dip))
```


Visualize population densities for selected taxa

```{r stability2, message=FALSE, warning=FALSE, fig.path = "figure/", fig.width=10, fig.height=5}
# Pick the most and least bimodal taxa as examples
unimodal <- names(which.min(bimodality))
bimodal <- names(which.max(bimodality))

# Visualize population frequencies
p1 <- plot_density(pseq, otu.name = unimodal, log10 = TRUE) 
p2 <- plot_density(pseq, otu.name = bimodal, log10 = TRUE) 
library(gridExtra)
grid.arrange(p1, p2, nrow = 1)
```


## Bimodality versus intermediate stability

The analysis suggests that bimodal taxa tend to have instable intermediate abundances (following [Lahti et al. Nat. Comm. 5:4344, 2014](http://www.nature.com/ncomms/2014/140708/ncomms5344/full/ncomms5344.html) but with a different subset, parameters and model):

```{r bimodalitybistability, message=FALSE, warning=FALSE, fig.path = "figure/"}
# For clarity, visualize only the prevalent taxa seen with HITChip signal >250
# (note HITChip signal reflects read count but is conceptually different) 
# in at least 10% of the samples. 
pseqf <- filter_taxa(pseq0, function(x) sum(x > 300) > (0.2*length(x)), TRUE)

# Taxa that have bistability and bimodality estimates
s <- taxa_names(pseqf)

plot(intermediate.stability[s], bimodality[s], xlab = "Intermediate stability", ylab = "Bimodality", type = "n")
text(intermediate.stability[s], bimodality[s], label = s, cex = 0.7)
```


### TODO

Add examples on tipping elements.


### Version information

```{r stabilitysessioninfo}
sessionInfo()
```

