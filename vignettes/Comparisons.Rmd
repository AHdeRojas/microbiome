---
title: "Comparisons"
author: "Leo Lahti"
date: "`r Sys.Date()`"
bibliography: 
- bibliography.bib
- references.bib
output: 
  rmarkdown::html_vignette
---
<!--
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{microbiome tutorial - comparisons}
  %\usepackage[utf8]{inputenc}
  %\VignetteEncoding{UTF-8}  
-->


## Group-wise comparisons

Load example data:

```{r boxplot-example, warning=FALSE, message=FALSE, fig.width=8, fig.height=5}
# Load libraries
library(microbiome)
library(ggplot2)
library(dplyr)

# Probiotics intervention example data 
data(peerj32) # Source: https://peerj.com/articles/32/
pseq <- peerj32$phyloseq # Rename the example data
```


### Abundance boxplot

```{r boxplot2, warning=FALSE, message=FALSE, fig.width=8, fig.height=5, out.width="300px"}
p <- boxplot_abundance(pseq, x = "time", y = "Akkermansia", line = "subject", color = "gender")
print(p)
```


### Negative binomial example

[Read more on negative binomials](http://www.ats.ucla.edu/stat/r/dae/nbreg.htm)

```{r comparisons2b}
library(MASS)

# Analyse specific taxa
taxa <- c("Akkermansia", "Dialister")
for (tax in taxa) {

  # Pick the signal (abundance) for this tax
  sample_data(pseq)$signal <- get_sample(pseq, tax)

  # Negative binomial test with group and gender included
  res <- glm.nb(signal ~ group + gender, data = pseq_metadata(pseq))

  # Show the results
  print(coef(summary(res)))

}
```


### Comparisons for individual taxa with random effect subject term

```{r comparisons-lmer}
# Get sample metadata
dfs <- pseq_metadata(pseq)

# Add Dialister abundance as the signal to model
dfs$signal <- abundances(pseq)["Dialister", rownames(dfs)]

# Paired comparison
# with fixed group effect and random subject effect
library(lme4)
out <- lmer(signal ~ group + (1|subject), data = dfs)
out0 <- lmer(signal ~ (1|subject), data = dfs)
comp <- anova(out0, out)
pv <- comp[["Pr(>Chisq)"]][[2]]
```


### Linear models with limma

Identify most significantly different taxa between males and females using the limma method. See [limma homepage](http://bioinf.wehi.edu.au/limma/) and [limma User's guide](http://www.lcg.unam.mx/~lcollado/R/resources/limma-usersguide.pdf) for details. For discussion on why limma is preferred over t-test, see [this
article](http://www.plosone.org/article/info:doi/10.1371/journal.pone.0012336).

```{r limma-example, warning=FALSE}
# Get OTU abundances and sample metadata
otu <- abundances(transform_phyloseq(pseq, "log10"))
meta <- sample_data(pseq)

# Compare the two groups with limma
library(limma)

# Prepare the design matrix which states the groups for each sample
# in the otu
design <- cbind(intercept = 1, Grp2vs1 = meta[["gender"]])
rownames(design) <- rownames(meta)
design <- design[colnames(otu), ]

# NOTE: results and p-values are given for all groupings in the design matrix
# Now focus on the second grouping ie. pairwise comparison
coef.index <- 2
     
# Fit the limma model
fit <- lmFit(otu, design)
fit <- eBayes(fit)

# Limma P-values
pvalues.limma = fit$p.value[, 2]

# Limma effect sizes
efs.limma <-  fit$coefficients[, "Grp2vs1"]

# Summarise
library(knitr)
kable(topTable(fit, coef = coef.index, p.value=0.1), digits = 2)
```

**Q-Q plot for limma**

```{r limma-qq, warning=FALSE}
qqt(fit$t[, coef.index], df = fit$df.residual + fit$df.prior)
abline(0,1)
```

**Volcano plot for limma**

```{r limma-volcano, warning=FALSE}
volcanoplot(fit, coef = coef.index, highlight = coef.index)
```


### PERMANOVA

PERMANOVA can be used to assess multivariate community-level
differences between groups. Here let us evaluate whether probiotics treatment
has a significant effect on overall gut microbiota composition.

```{r comparisons-permanova, fig.width=5, fig.height=6, message=FALSE, warnings=FALSE}
# Use compositionals for simpler visualizations
pseq.rel <- transform_phyloseq(pseq, "compositional")
otu <- abundances(pseq.rel)
meta <- pseq_metadata(pseq.rel)

# PERMANOVA: samples x species as input
library(vegan)
permanova <- adonis(t(otu) ~ group,
               data = meta, permutations=99, method = "bray")

# P-value
print(as.data.frame(permanova$aov.tab)["group", "Pr(>F)"])
```

Check that variance homogeneity assumptions hold (to ensure the reliability of the results):

```{r comparisons-permanova2, fig.width=5, fig.height=6, message=FALSE, warnings=FALSE}
# Note the assumption of similar multivariate spread among the groups
# ie. analogous to variance homogeneity
# Here the groups have signif. different spreads and
# permanova result may be potentially explained by that.
dist <- vegdist(t(otu))
anova(betadisper(dist, meta$group))

# Coefs for the top taxa separating the groups
coef <- coefficients(permanova)["group1",]
top.coef <- coef[rev(order(abs(coef)))[1:20]]
par(mar = c(3, 14, 2, 1))
barplot(sort(top.coef), horiz = T, las = 1, main = "Top taxa")
```

