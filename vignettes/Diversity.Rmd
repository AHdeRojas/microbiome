
To run these examples, you need to download the [HITChip Atlas data set](Data.md)

### Richness 

```{r rich-example, warning=FALSE, message=FALSE, fig.path = "figure/"}
library(microbiome)

# Get some HITChip data in phyloseq format
pseq <- download_microbiome("atlas1006")

# Pick the OTU data
# (note the zero point has been moved to the detection threshold;
#  typically signal 1.8 at HITChip log10 scale)
otu <- otu_table(pseq)@.Data

# Determine detection threshold at the 0.15 quantile
# Bacteria that exceed this threshold are considered present
# otherwise absent
det.th <- quantile(otu, 0.15)

# Visualize the detection threshold (at log10 scale for clarity)
plot(density(log10(otu)), main = "Detection threshold", xlab = "Abundance (Log10)", ylab = "Frequency")
abline(v = log10(det.th))

# Calculate richness.
# This indicates how many oligos are present in each sample
# (exceed the detection threshold)
ri <- rowSums(otu > det.th)
hist(ri, main = "Richness")
```


Highlight specific groups:

```{r richness, warning=FALSE, message=FALSE, fig.width=10, fig.height=7}
library(ggplot2)
data.dietswap <- download_microbiome("dietswap")
p <- plot_richness(data.dietswap, x = "gender", color = "group", measures = c("Shannon", "Simpson")) 
p <- p + geom_boxplot()
```


### Diversity 


```{r div-example, warning=FALSE, message=FALSE, fig.path = "figure/"}
di <- estimate_richness(pseq, measures = c("Shannon"))
hist(di$Shannon, main = "Diversity")
```

Plot richness vs. BMI with phyloseq tools (assuming you have the bmi_group field available in the sample metadata)

```{r div-example2, warning=FALSE, message=FALSE, fig.path = "figure/"}
p <- plot_richness(pseq, x = "bmi_group", measures = c("Chao1", "Shannon"))
p <- p + geom_boxplot()
print(p)
```

### Compare with known background factors

Diversity vs. obesity group (factor):

```{r diversitywithmetadata, warning=FALSE, message=FALSE, fig.width=8, fig.heigth=6, fig.path = "figure/"}
p <- plot_diversity(pseq, x = "bmi_group", measures = c("Shannon", "Simpson"))
print(p)
```

Diversity vs. age (continuous):

```{r diversitywithmetadata2, warning=FALSE, message=FALSE, fig.width=8, fig.heigth=6, fig.path = "figure/"}
p <- plot_diversity(pseq, x = "age", measures = "Shannon")
print(p)
```


Diversity vs. age with smoothed confidence intervals - manual version:

```{r diversity-example13, fig.width=8, fig.height=6, message=FALSE, warning=FALSE, fig.path = "figure/"}
library(microbiome)
library(sorvi)
library(dplyr)

# Add diversity into sample metadata
sample_data(pseq)$diversity <- estimate_richness(pseq, measures = c("Shannon"))$Shannon

# Select a subset of samples
pseq0 <- subset_samples(pseq, time == 0 & DNA_extraction_method == "r")

# Visualize
df <- sample_data(pseq0)
p <- sorvi::regression_plot(diversity ~ age, df)
print(p)
```

