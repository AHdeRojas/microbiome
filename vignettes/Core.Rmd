---
title: "Core"
author: "Leo Lahti"
date: "`r Sys.Date()`"
bibliography: 
- bibliography.bib
- references.bib
output: 
  rmarkdown::html_vignette
---
<!--
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{microbiome tutorial - core}
  %\usepackage[utf8]{inputenc}
  %\VignetteEncoding{UTF-8}  
-->

## Core microbiota analysis


### Prevalence of taxonomic groups

Load example data:

```{r core-prevalence}
# Load data
library(microbiome)
data(peerj32)

# Rename the data
pseq <- peerj32$phyloseq

# Calculate relative abundances
pseq.rel <- transform_phyloseq(pseq, "compositional", "OTU")
```


Taxa prevalences (population frequency) at 1% relative abundance abundance threshold:

```{r core-prevalence2}
head(prevalence(pseq.rel, detection = 1, sort = TRUE))
```


Alternatively, return the corresponding sample count instead of population frequency (relative = FALSE):

```{r core-prevalence2b}
head(prevalence(pseq.rel, detection = 1, sort = TRUE, relative = FALSE))
```



### Core microbiota

Core taxa above a given detection and prevalences:

```{r core-members, message=FALSE, warning=FALSE}
core.taxa <- core_members(pseq.rel, detection = 1, prevalence = 95)
```


Pick the core microbiota subset of the data:

```{r core-data, message=FALSE, warning=FALSE}c
pseq.core <- core(pseq.rel, detection = 1, prevalence = 95)
```


Total core abundance (sum of abundances of the core members):

```{r core-ab, message=FALSE, warning=FALSE}
core.abundance <- core_abundance(pseq.rel, detection = 1, prevalence = 95)
```


## Core visualization

### 2D line plots

Determine core microbiota across various abundance/prevalence
thresholds with the [blanket
analysis](http://onlinelibrary.wiley.com/doi/10.1111/j.1469-0691.2012.03855.x/abstract) based on various signal and prevalences. See also the the
bootstrap_microbes function.

```{r core-example2, fig.width=9, fig.heigth=6, fig.show='hold', out.width="430px"}
# With absolute read counts
det <- c(0, 1, 2, 5, 10, 20, 50, 100, 200, 500, 1000, 2000, 5000, 1e4)
prevalence.intervals <- seq(5, 100, 5)
p <- plot_core(pseq, prevalence.intervals = prevalence.intervals, detections = det, plot.type = "lineplot")
p + xlab("Abundance (OTU read count)")

# With relative abundances
det <- c(0, 0.1, 0.2, 0.5, 1, 2, 5, 10, 20)
p <- plot_core(pseq.rel, prevalence.intervals = prevalence.intervals, detections = det, plot.type = "lineplot")
p + xlab("Relative Abundance (%)")
```


### Core heatmaps

```{r core-example3, fig.width=8, fig.heigth=15, fig.show='hold', out.width = '430px'}
# Core with relative abundances:
prevalence.intervals <- seq(5, 100, 5)
detections <- 10^seq(log10(1e-3), log10(20), length = 20)

# Also define gray color palette
gray <- gray(seq(0,1,length=5))
p <- plot_core(pseq.rel, plot.type = "heatmap", colours = gray,
    prevalence.intervals = prevalence.intervals, detections = detections) 
print(p + xlab("Detection Threshold (Relative Abundance (%))"))

# Core with absolute counts and horizontal view:
detections <- 10^seq(log10(1), log10(max(abundances(pseq))/10), length = 20)		 
plot_core(pseq, plot.type = "heatmap", colours = gray,
       		 prevalence.intervals = prevalence.intervals,
       		 detections = detections,
		 min.prevalence = NULL, horizontal = TRUE)
```


Zoom in on the core region by filtering out rows and columns not passing min prevalence (given as percentages):

```{r core-example3bb, fig.width=8, fig.heigth=15, fig.show='hold', out.width='430px'}
p <- plot_core(pseq, plot.type = "heatmap", colours = gray,
                 prevalence.intervals = prevalence.intervals,
		 detections = detections,
		 min.prevalence = 10)
print(p)		 


library(RColorBrewer)
p <- plot_core(pseq, plot.type = "heatmap",
		 colours = rev(brewer.pal(5, "Spectral")),
                 prevalence.intervals = prevalence.intervals,
		 detections = detections,
		 min.prevalence = 0)		 
print(p)
```


