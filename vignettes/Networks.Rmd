---
title: "Taxonomic network visualization"
bibliography: 
- bibliography.bib
- references.bib
output: 
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
---
<!--
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{microbiome tutorial - networks}
  %\usepackage[utf8]{inputenc}
  %\VignetteEncoding{UTF-8}  
-->


```{r cleanup0, echo=FALSE, warning=FALSE, message=FALSE}
namespaces0 <- c("graphics", "utils", "grDevices", "stats", "datasets", "methods", "base", "grid", "Rcpp", "Biobase", "BiocGenerics", "lattice", "vegan", "parallel", "phyloseq", "mgcv", "GO.db", "S4Vectors", "rhdf5", "AnnotationDBI", "IRanges", "XVector", "Matrix", "tools", "assertthat", "MASS", "DBI", "scales", "stringi", "stringr", "codetools", "data.table", "multtest", "permute")
    # Must do to clean up some space
    for (i in 1:10) {
      pkgs0 <- setdiff(loadedNamespaces(), namespaces0)
      for (pkg in pkgs0) {
        print(c(pkg, length(pkgs0)))
        try(a <- unloadNamespace(pkg))
      }
    }
```

See also the [phyloseq tutorial](http://joey711.github.io/phyloseq/plot_network-examples)

Load [example data](Data.html):

```{r networks1, message=FALSE, warning=FALSE}
library(microbiome)
data(dietswap)
pseq <- dietswap
```


### Sample similarities

Network with phyloseq tools:

```{r networks3, warning=FALSE, message=FALSE}
theme_set(theme_bw(20))
p <- plot_net(pseq, maxdist = 0.2,
              shape = "group", color = "nationality",
	      distance = "bray", laymeth = "auto") +
     scale_colour_brewer(palette = "Accent")
print(p)		 
```


### Taxonomic network reconstruction 

The widely reported compositionality bias in similarity measures can
be fixed with SpiecEasi or SparCC; the implementations are available
via the [SpiecEasi package](https://github.com/zdk123/SpiecEasi). Note
that the execution is slow.

```{r networks4, warning=FALSE, message=FALSE, fig.width=10, fig.height=10}
library(SpiecEasi) #install_github("zdk123/SpiecEasi")
library(phyloseq)

# Pick the OTU table
otu <- t(abundances(pseq))

# SPIEC-EASI network reconstruction
# In practice, use more repetitions
net <- spiec.easi(otu, method='mb', lambda.min.ratio=1e-2, 
                  nlambda=20, icov.select.params=list(rep.num=20))

## Create graph object
n <- net$refit
colnames(n) <- rownames(n) <- colnames(otu)

# Network format
library(network)
netw <- network(as.matrix(n), directed = FALSE)

# igraph format
library(igraph)
ig <- graph.adjacency(n, mode='undirected', add.rownames = TRUE)

# Network layout
coord <- layout.fruchterman.reingold(ig)

## set size of vertex to log2 mean abundance 
vsize <- log2(apply(otu, 2, mean))

# Visualize the network
print(plot(ig, layout = coord, vertex.size = vsize, vertex.label = names(vsize)))
```


Investigate degree distribution with the following:

```{r degree, warning=FALSE, message=FALSE, fig.width=10, fig.height=7, eval=FALSE}
dd <- degree.distribution(ig)
plot(0:(length(dd)-1), dd, ylim=c(0,.35), type='b', 
      ylab="Frequency", xlab="Degree", main="Degree Distributions")
```


Visualize the network with [ggnet2](https://briatte.github.io/ggnet):

```{r networks5, warning=FALSE, message=FALSE, fig.width=12, fig.height=7}
library(GGally)
library(ggnet)
library(network)
library(sna)
library(ggplot2)
library(intergraph) # ggnet2 works also with igraph with this

phyla <- map_levels(colnames(otu), from = "Genus", to = "Phylum",
           tax_table(pseq))

netw %v% "Phylum" <- phyla
p <- ggnet2(netw, color = "Phylum", label = TRUE, label.size = 2)
print(p)
```


```{r cleanup2, echo=FALSE, warning=FALSE, message=FALSE}
    # Must do to clean up some space
    pkgs0 <- c("ade4",
      	       "compositions",
    	       "MASS",
    	       "moments",
    	       "scales",
    	       "tgp",
    	       "WGCNA",
    	       "diptest",
    	       "FD",
    	       "gcookbook",
    	       "GGally",
    	       "ggnet",
    	       "Hmisc",
    	       "hrbrthemes",
    	       "igraph",
    	       "intergraph",
    	       "limma",
    	       "lme4",
    	       "netresponse",
    	       "network",
    	       "RColorBrewer",
    	       "sna",
    	       "SpiecEasi",
    	       "tidyverse",
    	       "viridis")
    for (pkg in pkgs0) {
        print(pkg)
        try(a <- unloadNamespace(pkg))
    }
```


